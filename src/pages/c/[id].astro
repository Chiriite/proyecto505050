---
import Layout from '../../layouts/Layout.astro';
import CityDetailView from '../../components/CityDetailView.tsx';
import { citiesArray } from '../../hooks/useMapState';
import Back from '../../components/Back.astro';

// Required function for Astro dynamic routes - generates all possible city pages
export async function getStaticPaths() {

  return citiesArray.map((city) => ({
    params: { id: city.id.toString() },
    props: { city }
  }));
}

// Get the city from props (passed by getStaticPaths)
const { city } = Astro.props;

// Calculate navigation cities using the same cities array
const nextCity = citiesArray.find(c => c.order_number === city.order_number + 1);
const prevCity = citiesArray.find(c => c.order_number === city.order_number - 1);
---

<Layout 
  title={`${city.name} - Proyecto 50-50-50`}
  description={`Discover my running experience in ${city.name}, Spain. Run #${city.order_number} of my journey through 50 Spanish cities.`}
>
  <main class="relative w-full h-screen-safe overflow-hidden bg-background">
    <!-- City Detail View Component -->
    <CityDetailView 
      city={city}
      nextCity={nextCity}
      prevCity={prevCity}
      client:load
    />
    
    <!-- Back to Overview Button -->
    <div class="absolute top-6 left-6 z-[1001]">
      <Back />
    </div>
  </main>

  <!-- Custom page transitions for smooth navigation -->
  <style>
    @media (prefers-reduced-motion: no-preference) {
      main {
        animation: fadeInScale 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.98);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Smooth transition when navigating between cities */
    .city-transition {
      transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }
  </style>

  <!-- Enhanced page transitions script -->
  <script>
    // Handle smooth transitions between city pages
    document.addEventListener('DOMContentLoaded', () => {
      // Get city ID from URL
      const pathParts = window.location.pathname.split('/');
      const cityId = pathParts[2];
      
      if (cityId) {
        // Store the city ID for potential narrative mode navigation
        sessionStorage.setItem('currentCityId', cityId);
        
        // Check if this is a navigation from another city (narrative mode preparation)
        const fromCity = sessionStorage.getItem('fromCityId');
        if (fromCity) {
          // Add smooth transition class
          document.body.classList.add('city-transition');
          sessionStorage.removeItem('fromCityId');
        }
      }
    });

    // Enhanced navigation for narrative mode preparation
    function navigateToCity(cityId: string, smooth = true) {
      if (smooth) {
        sessionStorage.setItem('fromCityId', sessionStorage.getItem('currentCityId') || '');
      }
      window.location.href = `/c/${cityId}`;
    }

    // Keyboard navigation for narrative mode
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        const nextButton = document.querySelector('[data-nav="next"]');
        if (nextButton) (nextButton as HTMLElement).click();
      } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        const prevButton = document.querySelector('[data-nav="prev"]');
        if (prevButton) (prevButton as HTMLElement).click();
      } else if (e.key === 'Escape') {
        window.location.href = '/';
      }
    });
  </script>
</Layout>